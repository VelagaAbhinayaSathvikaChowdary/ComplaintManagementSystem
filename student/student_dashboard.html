<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="student.css">
</head>
<body>

<div class="student-dashboard">
  <!-- SIDEBAR -->
  <aside class="student-sidebar">
    <h2 class="logo">Student Panel</h2>
    <nav>
      <a href="#" class="active" onclick="showTab('raise')">Raise Complaint</a>
      <a href="#" onclick="showTab('track')">Track Status</a>
      <a href="student_login.html">Logout</a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="student-main">
    <!-- HEADER -->
    <header class="student-top-bar">
      <h1>Dashboard</h1>
      <span class="student-name" id="studentName">Welcome, Student</span>
    </header>

    <!-- TABS -->
    <div class="dashboard-tabs">
      <button class="tab-btn active" onclick="showTab('raise')">Raise Complaint</button>
      <button class="tab-btn" onclick="showTab('track')">Track Status</button>
    </div>

    <!-- RAISE COMPLAINT TAB -->
    <div id="raiseTab" class="tab-content active">
      <div class="complaint-form-card">
        <h2>Submit a Complaint</h2>
        
        <div class="success-message" id="successMessage">
          Complaint submitted successfully! Your complaint ID will be generated.
        </div>

        <form id="complaintForm" onsubmit="submitComplaint(event)">
          <div class="form-group">
            <label for="complaintType">Type of Complaint *</label>
            <select id="complaintType" required>
              <option value="">Select complaint type</option>
              <option value="Water">Water</option>
              <option value="Road">Road</option>
              <option value="Electricity">Electricity</option>
              <option value="Food">Food</option>
              <option value="Hostel">Hostel</option>
              <option value="Library">Library</option>
              <option value="Transport">Transport</option>
              <option value="Others">Others</option>
            </select>
          </div>

          <div class="form-group">
            <label for="location">Location *</label>
            <input type="text" id="location" placeholder="e.g., Block A, Room 101 or Library Ground Floor" required>
          </div>

          <div class="form-group">
            <label for="description">Description *</label>
            <textarea id="description" placeholder="Describe your complaint in detail..." required></textarea>
          </div>

          <button type="submit" class="submit-btn">Submit Complaint</button>
        </form>
      </div>
    </div>

    <!-- TRACK STATUS TAB -->
    <div id="trackTab" class="tab-content">
      <!-- Search by Complaint ID -->
      <div class="status-search-card">
        <h2>Track Your Complaint</h2>
        <div class="search-group">
          <input type="text" id="searchComplaintId" placeholder="Enter Complaint ID">
          <button class="search-btn" onclick="searchComplaint()">Search</button>
        </div>
      </div>

      <!-- Complaint Result -->
      <div class="complaint-result" id="complaintResult">
        <h3>Complaint Details</h3>
        <div class="result-item">
          <span class="label">Complaint ID:</span>
          <span class="value" id="resultId">-</span>
        </div>
        <div class="result-item">
          <span class="label">Type:</span>
          <span class="value" id="resultType">-</span>
        </div>
        <div class="result-item">
          <span class="label">Location:</span>
          <span class="value" id="resultLocation">-</span>
        </div>
        <div class="result-item">
          <span class="label">Description:</span>
          <span class="value" id="resultDescription">-</span>
        </div>
        <div class="result-item">
          <span class="label">Submitted On:</span>
          <span class="value" id="resultDate">-</span>
        </div>
        <div class="result-item">
          <span class="label">Status:</span>
          <span class="result-status" id="resultStatus">-</span>
        </div>
      </div>

      <!-- My Complaints List -->
      <div class="my-complaints-section">
        <h2>My Complaints</h2>
        <div class="complaint-list" id="myComplaintsList">
          <div class="empty-state">No complaints found. Submit your first complaint!</div>
        </div>
      </div>
    </div>

  </main>
</div>

<script src="student.js"></script>
<script>
  // Display student name
  const studentName = sessionStorage.getItem("currentStudent");
  if (studentName) {
    document.getElementById("studentName").textContent = "Welcome, " + studentName;
  } else {
    // Redirect to login if not logged in
    window.location.href = "student_login.html";
  }

  // Tab switching
  function showTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(tabName + 'Tab').classList.add('active');

    // Load complaints if track tab
    if (tabName === 'track') {
      loadMyComplaints();
    }
  }

  // Submit complaint
  async function submitComplaint(event) {
    event.preventDefault();

    const studentName = sessionStorage.getItem("currentStudent");
    const studentId = sessionStorage.getItem("currentStudentId");
    
    const complaintData = {
      studentName: studentName,
      studentId: studentId,
      category: document.getElementById("complaintType").value,
      location: document.getElementById("location").value,
      description: document.getElementById("description").value
    };

    try {
      const response = await fetch("http://localhost:5000/complaint", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(complaintData)
      });

      const result = await response.json();

      if (response.ok) {
        // Show success message
        document.getElementById("successMessage").style.display = "block";
        
        // Save to local storage for tracking
        const complaints = JSON.parse(localStorage.getItem("myComplaints") || "[]");
        complaints.push({
          _id: result._id,
          category: complaintData.category,
          location: complaintData.location,
          description: complaintData.description,
          status: result.status || "Pending",
          createdAt: new Date().toISOString()
        });
        localStorage.setItem("myComplaints", JSON.stringify(complaints));

        // Reset form
        document.getElementById("complaintForm").reset();

        // Hide success message after 3 seconds
        setTimeout(() => {
          document.getElementById("successMessage").style.display = "none";
        }, 3000);
      } else {
        alert("Failed to submit complaint. Please try again.");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error submitting complaint. Please check if the server is running.");
    }
  }

  // Search complaint by ID
  async function searchComplaint() {
    const complaintId = document.getElementById("searchComplaintId").value.trim();
    
    if (!complaintId) {
      alert("Please enter a complaint ID");
      return;
    }

    try {
      const response = await fetch("http://localhost:5000/complaint/" + complaintId);
      
      if (response.ok) {
        const complaint = await response.json();
        
        document.getElementById("resultId").textContent = complaint._id;
        document.getElementById("resultType").textContent = complaint.category;
        document.getElementById("resultLocation").textContent = complaint.location || "-";
        document.getElementById("resultDescription").textContent = complaint.description;
        document.getElementById("resultDate").textContent = new Date(complaint.createdAt).toLocaleDateString();
        
        const statusEl = document.getElementById("resultStatus");
        statusEl.textContent = complaint.status;
        statusEl.className = "result-status " + complaint.status.toLowerCase().replace(" ", "-");
        
        document.getElementById("complaintResult").style.display = "block";
      } else {
        alert("Complaint not found!");
        document.getElementById("complaintResult").style.display = "none";
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error searching complaint. Please check if the server is running.");
    }
  }

  // Load my complaints
  function loadMyComplaints() {
    const complaints = JSON.parse(localStorage.getItem("myComplaints") || "[]");
    const container = document.getElementById("myComplaintsList");

    if (complaints.length === 0) {
      container.innerHTML = '<div class="empty-state">No complaints found. Submit your first complaint!</div>';
      return;
    }

    container.innerHTML = complaints.map(complaint => `
      <div class="complaint-card">
        <div class="complaint-card-header">
          <h4>${complaint.category} - ${complaint.location || 'N/A'}</h4>
          <span class="result-status ${complaint.status.toLowerCase().replace(' ', '-')}">${complaint.status}</span>
        </div>
        <div class="complaint-card-body">
          <div>ID: ${complaint._id}</div>
          <div>Date: ${new Date(complaint.createdAt).toLocaleDateString()}</div>
        </div>
      </div>
    `).join('');
  }
</script>

</body>
</html>
